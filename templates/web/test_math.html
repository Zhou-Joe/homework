{% extends 'base.html' %}
{% load static %}

{% block title %}数学公式测试 - 学生学习平台{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">数学公式渲染测试</h1>

            <div class="card">
                <div class="card-header">
                    <h5>基础数学公式测试</h5>
                </div>
                <div class="card-body">
                    <h6>内联公式：</h6>
                    <p>这是一个内联公式：$x^2 + y^2 = r^2$，还有分数：$\frac{1}{2}$，根号：$\sqrt{x}$</p>

                    <h6>块级公式：</h6>
                    <div>$$\int_0^1 x^2 dx = \frac{1}{3}$$</div>

                    <h6>复杂公式：</h6>
                    <div>$$\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}$$</div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5>动态内容测试</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary me-2" onclick="testDynamicMath()">测试动态公式</button>
                    <button class="btn btn-success me-2" onclick="testAIContent()">测试AI内容格式</button>
                    <button class="btn btn-info" onclick="clearContent()">清空内容</button>

                    <div id="dynamicContent" class="mt-3 p-3 border rounded" style="min-height: 100px;">
                        <p class="text-muted">点击上方按钮测试动态数学公式渲染...</p>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5>调试信息</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary" onclick="showDebugInfo()">显示调试信息</button>
                    <div id="debugInfo" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 测试动态数学公式
async function testDynamicMath() {
    const content = `
        <h6>动态生成的数学公式：</h6>
        <p>二次方程求根公式：$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$</p>
        <div>$$\\alpha + \\beta = \\gamma$$</div>
        <p>希腊字母：$\\alpha$, $\\beta$, $\\gamma$, $\\pi$, $\\sigma$, $\\theta$</p>
    `;

    await setMathContent('#dynamicContent', content);
    showMessage('动态公式渲染完成', 'success');
}

// 测试AI生成的内容格式
async function testAIContent() {
    const aiResponse = {
        student_answer: "学生的答案是：$\\frac{3}{4} + \\frac{1}{2} = \\frac{5}{4}$",
        is_correct: false,
        error_analysis: "错误分析：学生计算 $\\frac{3}{4} + \\frac{1}{2}$ 时，没有找到共同的分母。正确做法是：$$\\frac{3}{4} + \\frac{1}{2} = \\frac{3}{4} + \\frac{2}{4} = \\frac{5}{4}$$",
        feedback: "学习建议：在做分数加法时，首先要找到共同的分母。记住公式：$$\\frac{a}{b} + \\frac{c}{d} = \\frac{ad + bc}{bd}$$"
    };

    const content = `
        <div class="alert alert-light">
            <h6>AI分析结果模拟：</h6>
            <p><strong>学生答案：</strong> <div id="testStudentAnswer">${aiResponse.student_answer}</div></p>
            <p><strong>错误分析：</strong> <div id="testErrorAnalysis">${aiResponse.error_analysis}</div></p>
            <p><strong>反馈建议：</strong> <div id="testFeedback">${aiResponse.feedback}</div></p>
        </div>
    `;

    document.getElementById('dynamicContent').innerHTML = content;

    // 分别渲染每个数学公式区域
    await setMathContent('#testStudentAnswer', aiResponse.student_answer);
    await setMathContent('#testErrorAnalysis', aiResponse.error_analysis);
    await setMathContent('#testFeedback', aiResponse.feedback);

    showMessage('AI内容格式测试完成', 'success');
}

// 清空内容
function clearContent() {
    document.getElementById('dynamicContent').innerHTML = '<p class="text-muted">点击上方按钮测试动态数学公式渲染...</p>';
}

// 显示调试信息
function showDebugInfo() {
    const info = {
        'MathJax已加载': !!window.MathJax,
        'MathJax版本': window.MathJax ? window.MathJax.version || '未知' : '未加载',
        'typesetPromise可用': window.MathJax && !!window.MathJax.typesetPromise,
        'document.readyState': document.readyState,
        '当前时间': new Date().toLocaleString()
    };

    let html = '<table class="table table-sm">';
    for (const [key, value] of Object.entries(info)) {
        html += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
    }
    html += '</table>';

    document.getElementById('debugInfo').innerHTML = html;

    // 测试MathJax渲染
    if (window.MathJax) {
        console.log('MathJax已加载，配置：', window.MathJax.config);
    } else {
        console.warn('MathJax未加载');
    }
}

// 页面加载完成后显示调试信息
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(showDebugInfo, 1000);
});
</script>
{% endblock %}