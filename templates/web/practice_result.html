{% extends 'base.html' %}
{% load static %}
{% now 'U' as cache_buster %}

{% block title %}练习结果 - 学生学习平台{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- AI分析状态提示 -->
    <div id="aiAnalysisStatus" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <div class="flex-grow-1">
                <strong>AI分析进行中</strong> - 老师正在认真分析您的答案，请稍候...
            </div>
            <div class="text-muted small" id="pendingCount">0</div>
        </div>
    </div>

    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-info text-white fade-in">
                <div class="card-body">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line me-3"></i>练习结果分析
                    </h1>
                    <p class="mb-0">详细的成绩分析和知识点掌握情况</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="row">
        <!-- 左侧：总体成绩 -->
        <div class="col-lg-4 mb-4">
            <!-- 总体得分卡片 -->
            <div class="card fade-in sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>总体成绩
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="display-1 text-primary fw-bold" id="totalScore">--</div>
                        <div class="text-muted">综合得分</div>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h4 text-success mb-0" id="correctCount">--</div>
                                <div class="small text-muted">答对题数</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-info mb-0" id="totalCount">--</div>
                            <div class="small text-muted">总题数</div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="scoreProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="small text-muted mt-1">正确率: <span id="accuracyRate">--</span>%</div>
                    </div>
                </div>
            </div>

            <!-- 知识点得分分布 -->
            <div class="card fade-in mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>知识点得分
                    </h5>
                </div>
                <div class="card-body">
                    <div id="knowledgePointScores">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>加载知识点得分...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：题目列表 -->
        <div class="col-lg-8 mb-4">
            <div class="card fade-in">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ol me-2"></i>答题详情
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterQuestions('all')">
                                全部
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="filterQuestions('correct')">
                                正确
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="filterQuestions('wrong')">
                                错误
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 统计信息 -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-muted me-2"></i>
                                <div>
                                    <small class="text-muted">总用时</small>
                                    <div class="fw-bold" id="totalTime">--分钟</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-fire text-warning me-2"></i>
                                <div>
                                    <small class="text-muted">连续正确</small>
                                    <div class="fw-bold" id="streak">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-pie text-info me-2"></i>
                                <div>
                                    <small class="text-muted">知识点覆盖</small>
                                    <div class="fw-bold" id="knowledgeCount">--个</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                <div>
                                    <small class="text-muted">平均难度</small>
                                    <div class="fw-bold" id="avgDifficulty">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 题目列表 -->
                    <div id="questionList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>加载答题记录...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="text-center mt-4">
                <button type="button" class="btn btn-success btn-lg me-3" onclick="startNewPractice()">
                    <i class="fas fa-redo me-2"></i>再次练习
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 题目详情模态框 -->
<div class="modal fade" id="questionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">题目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="questionDetailContent">
                <!-- 动态加载题目详情 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    /* Text colors */
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --text-white: #ffffff;

    /* Background colors */
    --bg-card: #e2e8f0;
    --bg-card-light: #dbeafe;

    /* Glass effect backgrounds */
    --glass-content-light: rgba(255, 255, 255, 0.6);
    --glass-content-medium: rgba(255, 255, 255, 0.7);
    --glass-content-heavy: rgba(255, 255, 255, 0.8);

    /* Border colors */
    --border-light: rgba(0, 0, 0, 0.05);
    --border-medium: rgba(0, 0, 0, 0.1);

    /* Color backgrounds */
    --bg-primary-light: rgba(99, 102, 241, 0.1);
    --bg-success-light: rgba(16, 185, 129, 0.1);
    --bg-danger-light: rgba(239, 68, 68, 0.1);
    --bg-warning-light: rgba(245, 158, 11, 0.1);
    --bg-info-light: rgba(6, 182, 212, 0.1);
}

/* 修复模态框背景和文字颜色 */
.modal-content {
    background: linear-gradient(135deg, var(--glass-content-heavy) 0%, var(--glass-content-medium) 100%) !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid var(--border-light) !important;
    color: var(--text-primary) !important;
}

.modal-header {
    background: var(--glass-content-light) !important;
    border-bottom: 1px solid var(--border-light) !important;
    color: var(--text-primary) !important;
}

.modal-title {
    color: var(--text-primary) !important;
    font-weight: 600;
}

.modal-body {
    color: var(--text-primary) !important;
    background: var(--glass-content-light) !important;
    border-radius: 8px !important;
    padding: 20px !important;
    line-height: 1.6 !important;
}

.modal-footer {
    background: var(--glass-content-light) !important;
    border-top: 1px solid var(--border-light) !important;
}

.btn-close {
    color: var(--text-secondary) !important;
    opacity: 1 !important;
}

.btn-close:hover {
    color: var(--text-primary) !important;
}

/* 确保题目内容完整显示 */
.question-content {
    word-wrap: break-word !important;
    white-space: pre-wrap !important;
    max-height: none !important;
    overflow: visible !important;
    line-height: 1.6 !important;
    font-size: 1.1em !important;
    color: var(--text-primary) !important;
    background: var(--glass-content-light) !important;
    border-radius: 8px !important;
    padding: 15px !important;
    border: 1px solid var(--border-light) !important;
    display: block !important;
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 20px !important;
    clear: both !important;
}

.answer-content {
    word-wrap: break-word !important;
    white-space: pre-wrap !important;
    max-height: none !important;
    overflow: visible !important;
    line-height: 1.6 !important;
    font-size: 1.1em !important;
    color: var(--text-primary) !important;
    background: var(--glass-content-light) !important;
    border-radius: 8px !important;
    padding: 15px !important;
    border: 1px solid var(--border-light) !important;
    display: block !important;
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 20px !important;
    clear: both !important;
}

/* 强制每个section分行 */
.mb-3 {
    margin-bottom: 25px !important;
    clear: both !important;
    width: 100% !important;
    display: block !important;
}

.mb-3 h5 {
    display: block !important;
    margin-bottom: 15px !important;
    width: 100% !important;
}

/* 强制题目内容和答案分开 */
.modal-body .row {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px !important;
}

.modal-body .row > div {
    width: 100% !important;
    flex: none !important;
    margin-bottom: 20px !important;
}

.modal-body .border.rounded {
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 隐藏解题步骤 */
.answer-steps {
    display: none !important;
}
</style>

<script>
// 全局变量
let practiceSession = null;
let practiceRecords = [];
let knowledgePointScores = {};
let currentFilter = 'all';

// 工具函数：获取URL参数
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// 全局变量用于自动刷新
let autoRefreshInterval = null;
let sessionId = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPracticeResult();
    // 启动自动刷新
    startAutoRefresh();
});

// 加载练习结果
async function loadPracticeResult() {
    try {
        // 从URL获取session_id或从localStorage获取
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id') || localStorage.getItem('last_practice_session');

        console.log('Session ID:', sessionId); // 调试信息

        if (!sessionId) {
            showMessage('未找到练习会话信息', 'warning');
            // 显示友好的提示
            document.getElementById('questionList').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>未找到练习会话</h5>
                    <p class="text-muted">请先完成一次练习再查看结果</p>
                    <a href="/practice/" class="btn btn-primary mt-3">开始练习</a>
                </div>
            `;
            return;
        }

        // 显示加载状态
        document.getElementById('questionList').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">正在加载练习结果...</p>
            </div>
        `;

        // 加载会话数据
        await loadSessionData(sessionId);

        // 显示结果
        displayResult();

        // 检查是否有pending状态的题目
        const hasPending = practiceRecords.some(record => record.status === 'pending');
        if (hasPending) {
            // 显示AI分析状态提示
            document.getElementById('aiAnalysisStatus').style.display = 'block';
        }

        // 加载知识点得分
        await loadKnowledgePointScores();

    } catch (error) {
        console.error('加载练习结果失败:', error);
        showMessage('加载失败: ' + error.message, 'danger');

        // 显示错误信息
        document.getElementById('questionList').innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                <h5>加载失败</h5>
                <p class="text-muted">${error.message}</p>
                <button onclick="location.reload()" class="btn btn-primary mt-3">重试</button>
            </div>
        `;
    }
}

// 加载会话数据
async function loadSessionData(sessionId) {
    const response = await apiRequest(`/practice/sessions/${sessionId}/`);
    practiceSession = response;

    // 加载答题记录
    const recordsResponse = await apiRequest(`/practice/records/?session_id=${sessionId}`);
    practiceRecords = recordsResponse.results || recordsResponse;
}

// 显示结果概览
function displayResult() {
    if (!practiceSession) return;

    // 更新总体得分
    const totalScore = practiceSession.score || 0;
    const correctCount = practiceSession.correct_answers || 0;
    const totalCount = practiceSession.total_questions || 0;
    const accuracyRate = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(1) : 0;

    document.getElementById('totalScore').textContent = totalScore.toFixed(1);
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('accuracyRate').textContent = accuracyRate;

    // 更新进度条
    document.getElementById('scoreProgress').style.width = accuracyRate + '%';

    // 计算统计数据
    calculateStatistics();

    // 显示题目列表
    displayQuestionList();
}

// 计算统计数据
function calculateStatistics() {
    if (practiceRecords.length === 0) return;

    // 总用时（分钟）
    const totalTime = practiceRecords.reduce((sum, record) =>
        sum + (record.response_time || 0), 0) / 60000;
    document.getElementById('totalTime').textContent = totalTime.toFixed(1) + '分钟';

    // 连续正确
    let maxStreak = 0;
    let currentStreak = 0;
    practiceRecords.forEach(record => {
        if (record.status === 'correct') {
            currentStreak++;
            maxStreak = Math.max(maxStreak, currentStreak);
        } else {
            currentStreak = 0;
        }
    });
    document.getElementById('streak').textContent = maxStreak;

    // 知识点覆盖
    const knowledgePoints = new Set();
    practiceRecords.forEach(record => {
        if (record.exercise && record.exercise.knowledge_points) {
            // 获取题目的所有知识点
            record.exercise.knowledge_points.forEach(kp => knowledgePoints.add(kp.name));
        }
    });
    document.getElementById('knowledgeCount').textContent = knowledgePoints.size + '个';

    // 平均难度
    const difficulties = { easy: 1, medium: 2, hard: 3 };
    const avgDiff = practiceRecords.reduce((sum, record) =>
        sum + (difficulties[record.exercise?.difficulty] || 2), 0) / practiceRecords.length;
    const diffText = avgDiff <= 1.5 ? '简单' : avgDiff <= 2.5 ? '中等' : '困难';
    document.getElementById('avgDifficulty').textContent = diffText;
}

// 显示题目列表
function displayQuestionList() {
    const questionList = document.getElementById('questionList');

    if (practiceRecords.length === 0) {
        questionList.innerHTML = '<div class="text-center text-muted py-4">暂无答题记录</div>';
        return;
    }

    let html = '<div class="list-group">';

    practiceRecords.forEach((record, index) => {
        const isPending = record.status === 'pending';
        const isCorrect = record.status === 'correct';
        const questionNumber = index + 1;

        // 获取知识点和考点信息
        let knowledgeInfo = '通用题目';
        if (record.exercise && record.exercise.knowledge_points) {
            const kps = record.exercise.knowledge_points;
            if (kps.length > 0) {
                knowledgeInfo = kps.map(kp => kp.name).join(' - ');
            }
        }

        // 难度显示
        const difficultyText = {
            easy: '简单',
            medium: '中等',
            hard: '困难'
        }[record.exercise?.difficulty] || '中等';

        // 响应时间
        const responseTime = record.response_time ?
            (record.response_time / 1000).toFixed(1) + '秒' : '--';

        // 状态显示
        let statusBadge = '';
        let listItemClass = '';
        let dataStatus = '';

        if (isPending) {
            statusBadge = '<span class="badge bg-warning">AI老师在分析</span>';
            listItemClass = 'list-group-item-warning';
            dataStatus = 'pending';
        } else if (isCorrect) {
            statusBadge = '<span class="badge bg-success">正确</span>';
            listItemClass = 'list-group-item-success';
            dataStatus = 'correct';
        } else {
            statusBadge = '<span class="badge bg-danger">错误</span>';
            listItemClass = 'list-group-item-danger';
            dataStatus = 'wrong';
        }

        html += `
            <div class="list-group-item ${listItemClass} question-item" data-status="${dataStatus}" data-record-id="${record.id}">
                <div class="row align-items-center">
                    <div class="col-md-1">
                        <span class="badge bg-primary fs-6">${questionNumber}</span>
                    </div>
                    <div class="col-md-4">
                        <div class="fw-bold">题目${questionNumber}</div>
                        <small class="text-muted">${knowledgeInfo}</small>
                    </div>
                    <div class="col-md-2">
                        ${statusBadge}
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">${difficultyText}</small>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">${responseTime}</small>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-sm btn-outline-info" onclick="showQuestionDetail(${index})"
                                ${isPending ? 'disabled title="AI分析中，请稍后查看"' : ''}>
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    questionList.innerHTML = html;
}

// 加载知识点得分
async function loadKnowledgePointScores() {
    try {
        const sessionId = getUrlParameter('session_id') || currentSession?.session_id;
        let apiUrl = '/practice/knowledge-points/';
        if (sessionId) {
            apiUrl += `?session_id=${sessionId}`;
        }

        const response = await apiRequest(apiUrl);
        const masteryData = response.results || response;

        // 如果没有知识点得分数据，显示空状态
        if (!masteryData || masteryData.length === 0) {
            document.getElementById('knowledgePointScores').innerHTML =
                '<div class="text-center text-muted">暂无知识点数据</div>';
            return;
        }

        // 处理API返回的知识点得分数据
        knowledgePointScores = {};
        masteryData.forEach(kpScore => {
            knowledgePointScores[kpScore.knowledge_point] = {
                name: kpScore.knowledge_point_name,
                score: kpScore.score,
                correct: kpScore.correct_answers,
                total: kpScore.total_questions,
                weight: kpScore.weight,
                accuracy_rate: kpScore.accuracy_rate
            };
        });

        displayKnowledgePointScores();

        // 计算并更新加权总分
        updateWeightedTotalScore();

    } catch (error) {
        console.error('加载知识点得分失败:', error);
        document.getElementById('knowledgePointScores').innerHTML =
            '<div class="text-center text-danger">加载失败</div>';
    }
}

// 显示知识点得分
function displayKnowledgePointScores() {
    const container = document.getElementById('knowledgePointScores');

    if (Object.keys(knowledgePointScores).length === 0) {
        container.innerHTML = '<div class="text-center text-muted">暂无知识点数据</div>';
        return;
    }

    let html = '';
    Object.values(knowledgePointScores).forEach(kp => {
        const scoreColor = kp.score >= 80 ? 'success' : kp.score >= 60 ? 'warning' : 'danger';

        html += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">${kp.name}</span>
                    <span class="badge bg-${scoreColor}">${kp.score.toFixed(1)}%</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-${scoreColor}" style="width: ${kp.score}%"></div>
                </div>
                <small class="text-muted">${kp.correct}/${kp.total} 题正确 (权重: ${kp.weight})</small>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 计算并更新加权总分
function updateWeightedTotalScore() {
    const kpScores = Object.values(knowledgePointScores);

    if (kpScores.length === 0) {
        return;
    }

    // 计算加权总分: Σ(得分 × 权重) / Σ(权重)
    let weightedSum = 0;
    let totalWeight = 0;

    kpScores.forEach(kp => {
        weightedSum += kp.score * kp.weight;
        totalWeight += kp.weight;
    });

    const weightedScore = totalWeight > 0 ? weightedSum / totalWeight : 0;

    // 更新页面显示的得分
    const totalScoreElement = document.getElementById('totalScore');
    if (totalScoreElement) {
        totalScoreElement.textContent = weightedScore.toFixed(1);
    }

    // 更新进度条
    const scoreProgressElement = document.getElementById('scoreProgress');
    if (scoreProgressElement) {
        scoreProgressElement.style.width = weightedScore + '%';
    }

    // 更新正确率显示
    const accuracyRateElement = document.getElementById('accuracyRate');
    if (accuracyRateElement) {
        accuracyRateElement.textContent = weightedScore.toFixed(1);
    }

    console.log(`加权总分计算完成: ${weightedScore.toFixed(1)}分 (基于${kpScores.length}个知识点)`);
}

// 筛选题目
function filterQuestions(status) {
    currentFilter = status;
    const items = document.querySelectorAll('.question-item');

    items.forEach(item => {
        if (status === 'all') {
            item.style.display = 'block';
        } else {
            const itemStatus = item.dataset.status;
            item.style.display = itemStatus === status ? 'block' : 'none';
        }
    });

    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// 显示题目详情
function showQuestionDetail(index) {
    const record = practiceRecords[index];
    if (!record) return;

    const modal = new bootstrap.Modal(document.getElementById('questionDetailModal'));
    const content = document.getElementById('questionDetailContent');

    // 构建题目详情内容
    let html = `
        <div class="mb-4">
            <h6>题目内容</h6>
            <div class="border rounded p-3 mb-4">
                <div id="questionDetailContent_${index}" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">加载中...</div>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <h6>你的答案</h6>
            <div class="border rounded p-3 mb-3">
                ${record.student_answer_text || '未识别'}
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h6>AI分析</h6>
                <div class="alert alert-${record.status === 'correct' ? 'success' : 'danger'}">
                    <div id="detailAnalysisContent"></div>
                </div>
            </div>
        </div>
    `;

    content.innerHTML = html;

    modal.show();

    // 加载题目内容
    loadQuestionContent(index, record);

    // 渲染数学公式
    setTimeout(async () => {
        if (record.llm_analysis?.feedback) {
            const analysisDiv = document.getElementById('detailAnalysisContent');
            if (analysisDiv) {
                analysisDiv.innerHTML += `
                    <p><strong>AI反馈：</strong> ${record.llm_analysis.feedback}</p>
                `;
                await renderMathInElement(analysisDiv);
            }
        }
    }, 100);
}

// 加载实际题目内容
function loadQuestionContent(index, record) {
    try {
        // 获取exercise ID - 处理不同的数据结构
        const exerciseId = record.exercise?.id || record.exercise_id || record.id;
        console.log(`Loading exercise ${exerciseId} for record ${index}:`, record);

        // 检查认证状态
        console.log('Current access token:', localStorage.getItem('access_token') ? 'Present' : 'Missing');
        console.log('Current refresh token:', localStorage.getItem('refresh_token') ? 'Present' : 'Missing');

        if (!exerciseId) {
            console.error('No exercise ID found in record:', record);
            const contentDiv = document.getElementById(`questionDetailContent_${index}`);
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>数据错误</h5>
                        <p>无法找到题目ID</p>
                    </div>
                `;
            }
            return;
        }

        // 从API获取题目详情 - 使用正确的API路径
        console.log('Loading exercise detail for ID:', exerciseId);
        apiRequest(`/api/exercises/${exerciseId}/`)
            .then(exerciseData => {
                console.log('Loaded exercise detail:', exerciseData);

                // 更新题目详情内容
                const contentDiv = document.getElementById(`questionDetailContent_${index}`);
                if (contentDiv) {
                    let contentHtml = '';

                    // 显示题目图片
                    if (exerciseData.question_image) {
                        contentHtml += `
                            <div class="mb-3" style="background: var(--glass-content-medium); backdrop-filter: blur(10px); border: 1px solid var(--border-light); border-radius: 8px; padding: 15px;">
                                <img src="${exerciseData.question_image}" class="img-fluid rounded" alt="题目">
                            </div>
                        `;
                    }

                    // 显示题目文字
                    if (exerciseData.question_text) {
                        contentHtml += `
                            <div class="mb-3 p-3 rounded" style="background: var(--glass-content-medium); backdrop-filter: blur(10px); border: 1px solid var(--border-light); color: var(--text-primary); line-height: 1.6;">
                                <h5 style="color: var(--text-primary); margin-bottom: 15px;">题目内容</h5>
                                <div class="question-content" style="color: var(--text-primary);">${exerciseData.question_text}</div>
                            </div>
                        `;
                    }

                    // 显示标准答案
                    if (exerciseData.answer_text) {
                        contentHtml += `
                            <div class="mb-3 p-3 rounded" style="background: var(--bg-success-light); backdrop-filter: blur(10px); border: 1px solid var(--border-medium); border-radius: 8px; color: var(--text-primary);">
                                <h5 style="color: var(--text-primary); margin-bottom: 15px;">标准答案</h5>
                                <div class="question-content" style="color: var(--text-primary);">${exerciseData.answer_text}</div>
                            </div>
                        `;
                    }

                    // 尝试：确保内容div存在
                    if (contentDiv) {
                        contentDiv.innerHTML = contentHtml;
                        console.log(`Updated content for question ${index}, contentDiv exists:`, !!contentDiv);
                    } else {
                        console.error(`Content div not found for question ${index}`);
                    }

                    // 渲染数学公式
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise().then(() => {
                            console.log('MathJax rendered for question:', index);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Failed to load question detail:', error);
                const contentDiv = document.getElementById(`questionDetailContent_${index}`);
                if (contentDiv) {
                    // 如果API请求失败，尝试从现有的record数据中显示信息
                    let fallbackContent = '';

                    if (error.message.includes('401') || error.message.includes('403')) {
                        fallbackContent = `
                            <div class="alert alert-warning">
                                <h5>认证失败</h5>
                                <p>需要重新登录才能查看题目详情</p>
                                <button onclick="location.href='/login/'" class="btn btn-primary btn-sm">重新登录</button>
                            </div>
                        `;
                    } else if (error.message.includes('404')) {
                        // 尝试从练习记录中获取题目信息
                        const recordData = practiceRecords[index];
                        if (recordData && recordData.exercise) {
                            fallbackContent = `
                                <div class="p-3 rounded" style="background: var(--glass-content-medium); backdrop-filter: blur(10px); border: 1px solid var(--border-light);">
                                    ${recordData.exercise_question_text ?
                                        `<div class="mb-3">
                                            <strong style="color: var(--text-primary); display: block; margin-bottom: 15px;">题目内容</strong>
                                            <div class="p-3 rounded mt-2 question-content">${recordData.exercise_question_text}</div>
                                        </div>` : ''
                                    }
                                    ${recordData.exercise_correct_answer ?
                                        `<div class="mb-3">
                                            <strong style="color: var(--text-primary); display: block; margin-bottom: 15px;">标准答案</strong>
                                            <div class="p-3 rounded mt-2" style="background: var(--bg-success-light); backdrop-filter: blur(10px); border: 1px solid var(--border-medium); border-radius: 8px; color: var(--text-primary);">${recordData.exercise_correct_answer}</div>
                                        </div>` : ''
                                    }
                                    </div>
                            `;
                        } else {
                            fallbackContent = `
                                <div class="alert alert-warning">
                                    <h5>题目不存在</h5>
                                    <p>该题目可能已被删除或移动</p>
                                </div>
                            `;
                        }
                    } else {
                        fallbackContent = `
                            <div class="alert alert-warning">
                                <h5>暂时无法加载详情</h5>
                                <p>网络或服务器问题，请稍后重试</p>
                                <p class="text-muted small mb-2">错误信息: ${error.message}</p>
                            </div>
                        `;
                    }

                    // 尝试显示本地数据
                    const exercise = record.exercise;
                    if (exercise) {
                        fallbackContent += ``;
                    }

                    contentDiv.innerHTML = fallbackContent;
                }
            });
    } catch (error) {
        console.error('Error in loadQuestionContent:', error);
    }
}

// 开始自动刷新
function startAutoRefresh() {
    // 获取当前会话ID
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id') || localStorage.getItem('last_practice_session');

    if (!sessionId) {
        return;
    }

    // 每3秒检查一次AI分析状态
    autoRefreshInterval = setInterval(async () => {
        try {
            await checkAnalysisStatus();
        } catch (error) {
            console.error('检查AI分析状态失败:', error);
        }
    }, 3000);
}

// 检查AI分析状态
async function checkAnalysisStatus() {
    if (!sessionId) return;

    try {
        // 获取分析状态
        const statusResponse = await apiRequest(`/practice/sessions/${sessionId}/analysis-status/`);

        if (statusResponse.analysis_complete) {
            // AI分析完成，停止自动刷新并重新加载数据
            stopAutoRefresh();
            await loadPracticeResult();
            showMessage('AI分析已完成！', 'success');
        }

        // 更新pending计数
        const pendingCountElement = document.getElementById('pendingCount');
        if (pendingCountElement) {
            pendingCountElement.textContent = statusResponse.pending_count;
        }

        // 如果还有待分析的题目，更新显示
        if (statusResponse.pending_count > 0) {
            // 只更新有pending状态的题目显示
            updatePendingQuestions();
        }

    } catch (error) {
        console.error('获取分析状态失败:', error);
    }
}

// 更新pending状态的题目显示
async function updatePendingQuestions() {
    try {
        // 重新加载答题记录
        const recordsResponse = await apiRequest(`/practice/records/?session_id=${sessionId}`);
        const newRecords = recordsResponse.results || recordsResponse;

        // 检查是否有状态变化
        let hasChanges = false;
        newRecords.forEach((newRecord, index) => {
            if (practiceRecords[index] && practiceRecords[index].status !== newRecord.status) {
                practiceRecords[index] = newRecord;
                hasChanges = true;
            }
        });

        // 如果有状态变化，更新显示
        if (hasChanges) {
            displayQuestionList();
            // 重新计算统计数据
            calculateStatistics();
        }

    } catch (error) {
        console.error('更新pending题目失败:', error);
    }
}

// 停止自动刷新
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// 页面卸载时停止自动刷新
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// 开始新的练习
function startNewPractice() {
    stopAutoRefresh();
    window.location.href = '/practice/';
}
</script>

{% endblock %}