{% extends 'base.html' %}
{% load static %}

{% block title %}å­¦ä¹ é©¾é©¶èˆ± - å­¦ç”Ÿå­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<!-- æ²‰æµ¸å¼æ¬¢è¿åŒºåŸŸ -->
<div class="hero-section mb-5">
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>
    
    <div class="glass-card hero-card fade-in">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="pulse-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="hero-text chinese-text">
                        <h1 class="display-6 mb-1">
                            æ¬¢è¿å›æ¥ï¼Œ<span class="user-name">{{ user.nickname }}</span>ï¼
                        </h1>
                        <p class="text-muted mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="typewriter">è®©æˆ‘ä»¬æ¥åˆ†æä½ çš„å­¦ä¹ è½¨è¿¹...</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="avatar-wrapper d-inline-block me-4">
                    <div class="user-avatar modern-avatar">
                        {{ user.nickname|first|upper }}
                    </div>
                    <div class="avatar-glow"></div>
                </div>
                <div class="meta-info d-inline-block text-start">
                    <div class="badge badge-grade">
                        <i class="fas fa-layer-group me-1"></i>{{ user.grade_level }}
                    </div>
                    <div class="join-date">
                        <i class="fas fa-calendar-alt me-1"></i>{{ user.created_at|date:"Yå¹´mæœˆdæ—¥" }}åŠ å…¥
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ - Neumorphic Design -->
<div class="stats-grid mb-5">
    <div class="stat-card-wrapper">
        <div class="stat-card neumorph" data-stat="totalExercises">
            <div class="stat-icon">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="stat-value" id="totalExercises">
                <span class="skeleton-loader"></span>
            </div>
            <div class="stat-label chinese-text">æ€»ä¹ é¢˜æ•°</div>
            <div class="stat-progress"></div>
        </div>
    </div>
    
    <div class="stat-card-wrapper">
        <div class="stat-card neumorph" data-stat="mistakeCount">
            <div class="stat-icon error">
                <i class="fas fa-brain"></i>
            </div>
            <div class="stat-value" id="mistakeCount">
                <span class="skeleton-loader"></span>
            </div>
            <div class="stat-label chinese-text">å¾…æ”»å…‹é”™é¢˜</div>
            <div class="stat-progress error"></div>
        </div>
    </div>
    
    <div class="stat-card-wrapper">
        <div class="stat-card neumorph" data-stat="practiceCount">
            <div class="stat-icon success">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="stat-value" id="practiceCount">
                <span class="skeleton-loader"></span>
            </div>
            <div class="stat-label chinese-text">ç»ƒä¹ æ¬¡æ•°</div>
            <div class="stat-progress success"></div>
        </div>
    </div>
    
    <div class="stat-card-wrapper">
        <div class="stat-card neumorph" data-stat="accuracyRate">
            <div class="stat-icon info">
                <i class="fas fa-bullseye"></i>
            </div>
            <div class="stat-value" id="accuracyRate">
                <span class="skeleton-loader"></span>
            </div>
            <div class="stat-label chinese-text">æ­£ç¡®ç‡</div>
            <div class="stat-progress info"></div>
        </div>
    </div>
</div>

<!-- ä¸»è¦å†…å®¹ç½‘æ ¼ -->
<div class="content-grid mb-5">
    <!-- å­¦ç§‘ç»Ÿè®¡ - Glass Card -->
    <div class="glass-section lg">
        <div class="section-header">
            <div class="section-icon">
                <i class="fas fa-chart-network"></i>
            </div>
            <h3 class="section-title">å­¦ç§‘æŒæ¡åº¦åˆ†æ</h3>
            <div class="decorative-line"></div>
        </div>
        <div class="section-body">
            <div id="subjectStats" class="loading-modern">
                <div class="skeleton-grid">
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è–„å¼±çŸ¥è¯†ç‚¹ - Warm Gradient -->
    <div class="glass-section lg">
        <div class="section-header warning">
            <div class="section-icon">
                <i class="fas fa-crosshairs"></i>
            </div>
            <h3 class="section-title">ç²¾å‡†æå‡ç›®æ ‡</h3>
            <div class="decorative-line warning"></div>
        </div>
        <div class="section-body">
            <div id="weakKnowledgePoints" class="loading-modern">
                <div class="skeleton-grid-horizontal">
                    <div class="skeleton-item-horizontal"></div>
                    <div class="skeleton-item-horizontal"></div>
                    <div class="skeleton-item-horizontal"></div>
                    <div class="skeleton-item-horizontal"></div>
                    <div class="skeleton-item-horizontal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœ€è¿‘é”™é¢˜ - Interactive Cards -->
<div class="glass-section lg mb-5">
    <div class="section-header primary">
        <div class="section-icon">
            <i class="fas fa-history"></i>
        </div>
        <h3 class="section-title">æœ€è¿‘é”™é¢˜å›é¡¾</h3>
        <a href="/upload/" class="btn-modern btn-primary">
            <i class="fas fa-plus me-2"></i>
            <span>ä¸Šä¼ æ–°é¢˜</span>
        </a>
    </div>
    <div class="section-body">
        <div id="recentMistakes" class="loading-modern">
            <div class="skeleton-mistakes">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ - Icon Grid -->
<div class="quick-actions">
    <div class="section-header success">
        <div class="section-icon">
            <i class="fas fa-rocket"></i>
        </div>
        <h3 class="section-title">å¿«é€Ÿå¯åŠ¨å°</h3>
    </div>
    <div class="action-grid">
        <a href="/upload/" class="action-card" data-action="upload">
            <div class="action-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="action-label">ä¸Šä¼ é”™é¢˜</div>
            <div class="action-desc">æ‹ç…§æˆ–è¾“å…¥æ–°é¢˜ç›®</div>
        </a>
        
        <a href="/practice/" class="action-card" data-action="practice">
            <div class="action-icon success">
                <i class="fas fa-dumbbell"></i>
            </div>
            <div class="action-label">æ™ºèƒ½è®­ç»ƒ</div>
            <div class="action-desc">ä¸ªæ€§åŒ–æ¨èç»ƒä¹ </div>
        </a>
        
        <button class="action-card" onclick="viewAllMistakes()" data-action="view">
            <div class="action-icon info">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="action-label">é”™é¢˜å®åº“</div>
            <div class="action-desc">æŸ¥çœ‹å…¨éƒ¨é”™é¢˜</div>
        </button>
        
        {% if user.user_type == 'admin' %}
        <a href="{% url 'web:settings' %}" class="action-card" data-action="settings">
            <div class="action-icon warning">
                <i class="fas fa-cog"></i>
            </div>
            <div class="action-label">ç³»ç»Ÿé…ç½®</div>
            <div class="action-desc">ç®¡ç†åå°è®¾ç½®</div>
        </a>
        {% endif %}
    </div>
</div>

<!-- ä¹ é¢˜è¯¦æƒ…æ¨¡æ€æ¡† - Glass Overlay -->
<div class="modal modal-glass fade" id="exerciseDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content glass-modal">
            <div class="modal-header glass-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>ä¹ é¢˜æ·±åº¦è§£æ
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body glass-body">
                <div id="exerciseDetailContent">
                    <div class="loading-detail">
                        <div class="spinner-modern"></div>
                        <p class="mt-3 text-muted">æ„å»ºçŸ¥è¯†å›¾è°±ä¸­...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer glass-footer">
                <button type="button" class="btn-modern btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å…³é—­
                </button>
                <button type="button" class="btn-modern btn-primary" id="practiceThisBtn">
                    <i class="fas fa-play me-2"></i>ç«‹å³ç»ƒä¹ 
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}

{% block base_style_css %}
<!-- Dashboardé¡µé¢ä¸åŠ è½½base style.cssï¼Œé¿å…æ ·å¼å†²çª -->
{% endblock %}

<style>
:root {
    --color-primary: #6366f1;
    --color-primary-dark: #4f46e5;
    --color-success: #10b981;
    --color-warning: #f59e0b;
    --color-danger: #ef4444;
    --color-info: #06b6d4;
    --bg-main: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.4);
    --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.15);
    --shadow-hover: 0 12px 40px rgba(31, 38, 135, 0.25);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    background: var(--bg-main);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif;
    color: #1e293b;
    writing-mode: horizontal-tb;
    text-orientation: mixed;
    direction: ltr;
}

/* ç¡®ä¿æ‰€æœ‰æ–‡æœ¬éƒ½æ°´å¹³æ˜¾ç¤º */
* {
    writing-mode: horizontal-tb !important;
    text-orientation: mixed !important;
    direction: ltr !important;
}

/* ä¸­æ–‡å­—ä½“ä¼˜åŒ– */
.chinese-text {
    font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', 'Hiragino Sans GB', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;
}

/* æ¬¢è¿åŒºåŸŸ - Animated Background */
.hero-section {
    position: relative;
    overflow: hidden;
    padding: 2rem 0;
}

.floating-shapes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

.shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(40px);
    opacity: 0.7;
    animation: float 6s ease-in-out infinite;
}

.shape-1 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    top: -100px;
    left: -50px;
    animation-delay: 0s;
}

.shape-2 {
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, #10b981, #06b6d4);
    bottom: -75px;
    right: 10%;
    animation-delay: 2s;
}

.shape-3 {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    top: 50%;
    right: -30px;
    animation-delay: 4s;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}

.hero-card {
    padding: 2.5rem;
    border-radius: 24px;
    backdrop-filter: blur(12px);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow-soft);
}

.pulse-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
    animation: pulse 2s infinite;
}

.pulse-icon i {
    color: white;
    font-size: 1.5rem;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
    100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
}

.typewriter {
    overflow: hidden;
    border-right: 2px solid var(--color-primary);
    white-space: nowrap;
    animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
    from { width: 0 }
    to { width: 100% }
}

@keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: var(--color-primary) }
}

/* ç°ä»£å¤´åƒ */
.modern-avatar {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
    font-weight: 700;
    position: relative;
    z-index: 2;
}

.avatar-wrapper {
    position: relative;
}

.avatar-glow {
    position: absolute;
    top: -5px;
    left: -5px;
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 70%);
    border-radius: 50%;
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { transform: scale(1); opacity: 0.5; }
    to { transform: scale(1.1); opacity: 0.8; }
}

.meta-info .badge-grade {
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    color: white;
}

.join-date {
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 0.5rem;
}

/* ç»Ÿè®¡å¡ç‰‡ - Neumorphic */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card-wrapper {
    perspective: 1000px;
}

.stat-card.neumorph {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: var(--transition);
    cursor: pointer;
    backdrop-filter: blur(10px);
}

.stat-card.neumorph:hover {
    transform: translateY(-8px) rotateX(5deg);
    box-shadow: var(--shadow-hover);
}

.stat-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
}

.stat-icon.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
}

.stat-icon.success {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
}

.stat-icon.info {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    box-shadow: 0 4px 20px rgba(6, 182, 212, 0.3);
}

.stat-icon i {
    color: white;
    font-size: 1.8rem;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #1e293b, #334155);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.95rem;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    width: 0%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dark));
    transition: width 1.5s ease-out;
}

.stat-progress.error {
    background: linear-gradient(90deg, #ef4444, #dc2626);
}

.stat-progress.success {
    background: linear-gradient(90deg, #10b981, #059669);
}

.stat-progress.info {
    background: linear-gradient(90deg, #06b6d4, #0891b2);
}

/* å†…å®¹ç½‘æ ¼ */
.content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
}

@media (max-width: 992px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

.glass-section {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 1.5rem;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-soft);
    transition: var(--transition);
}

.glass-section:hover {
    box-shadow: var(--shadow-hover);
}

.glass-section.lg {
    grid-column: span 2;
}

@media (max-width: 992px) {
    .glass-section.lg {
        grid-column: span 1;
    }
}

.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.section-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}

.section-icon.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}

.section-icon.primary {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
}

.section-icon.success {
    background: linear-gradient(135deg, #10b981, #059669);
}

.section-icon.info {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.section-icon i {
    color: white;
    font-size: 1.3rem;
}

.section-title {
    margin: 0;
    font-weight: 700;
    color: #1e293b;
}

.decorative-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
    margin-left: 1rem;
}

/* éª¨æ¶å± */
.skeleton-loader {
    display: inline-block;
    width: 80px;
    height: 2.5rem;
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.skeleton-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.skeleton-item {
    height: 80px;
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 12px;
}

.skeleton-list .skeleton-line {
    height: 60px;
    margin-bottom: 0.75rem;
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 12px;
}

.skeleton-grid-horizontal {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.8rem;
}

@media (max-width: 1400px) {
    .skeleton-grid-horizontal {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 1200px) {
    .skeleton-grid-horizontal {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 900px) {
    .skeleton-grid-horizontal {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .skeleton-grid-horizontal {
        grid-template-columns: 1fr;
    }
}

.skeleton-item-horizontal {
    height: 80px;
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 12px;
}

.skeleton-mistakes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.skeleton-card {
    height: 200px;
    background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 16px;
}

/* åŠ è½½çŠ¶æ€ */
.loading-modern {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.spinner-modern {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(99, 102, 241, 0.2);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* å­¦ç§‘ç»Ÿè®¡å†…å®¹ */
.subject-item {
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 14px;
    margin-bottom: 1rem;
    transition: var(--transition);
    border: 1px solid rgba(0,0,0,0.05);
}

.subject-item:hover {
    background: rgba(255, 255, 255, 0.8);
    transform: translateX(5px);
}

.subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.subject-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 1.1rem;
}

.accuracy-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
}

.progress-custom {
    height: 10px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 1s ease-out;
}

.subject-meta {
    font-size: 0.875rem;
    color: #64748b;
    display: flex;
    gap: 1rem;
}

/* è–„å¼±çŸ¥è¯†ç‚¹ */
.knowledge-item {
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 14px;
    margin-bottom: 0.75rem;
    transition: var(--transition);
    border: 1px solid rgba(0,0,0,0.05);
}

.knowledge-item:hover {
    background: rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
}

.knowledge-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.knowledge-info {
    flex: 1;
}

.knowledge-info h6 {
    margin: 0 0 0.25rem 0;
    font-weight: 600;
    color: #1e293b;
}

.knowledge-subject {
    font-size: 0.875rem;
    color: #64748b;
}

.knowledge-stats {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.mastery-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
}

.attempt-count {
    font-size: 0.75rem;
    color: #94a3b8;
    white-space: nowrap;
}

/* æ¨ªæ’å¸ƒå±€æ ·å¼ - æ¯è¡Œ5é¡¹ */
.knowledge-grid-horizontal {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.8rem;
}

.mistakes-grid-horizontal {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
}

/* è‡ªé€‚åº”å¸ƒå±€ - è‡ªåŠ¨æ¢è¡Œ */
.mistakes-grid-auto {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    width: 100%;
}

/* å¼ºåˆ¶ç²¾å‡†æå‡ç›®æ ‡åŒºåŸŸä½¿ç”¨è‡ªé€‚åº”å¸ƒå±€ */
#weakKnowledgePoints .mistakes-grid-auto {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
}

@media (min-width: 1400px) {
    #weakKnowledgePoints .mistakes-grid-auto {
        grid-template-columns: repeat(5, 1fr) !important;
    }
}

@media (min-width: 1200px) and (max-width: 1399px) {
    #weakKnowledgePoints .mistakes-grid-auto {
        grid-template-columns: repeat(4, 1fr) !important;
    }
}

@media (min-width: 900px) and (max-width: 1199px) {
    #weakKnowledgePoints .mistakes-grid-auto {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

@media (min-width: 600px) and (max-width: 899px) {
    #weakKnowledgePoints .mistakes-grid-auto {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

@media (max-width: 599px) {
    #weakKnowledgePoints .mistakes-grid-auto {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 1400px) {
    .knowledge-grid-horizontal,
    .mistakes-grid-horizontal {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 1200px) {
    .knowledge-grid-horizontal,
    .mistakes-grid-horizontal {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 900px) {
    .knowledge-grid-horizontal,
    .mistakes-grid-horizontal {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .knowledge-grid-horizontal,
    .mistakes-grid-horizontal {
        grid-template-columns: 1fr;
    }
}

/* é”™é¢˜å¡ç‰‡ */
.mistakes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
}

.mistake-card {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 16px;
    overflow: hidden;
    transition: var(--transition);
    cursor: pointer;
}

.mistake-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
}

.card-image {
    width: 100%;
    height: 150px;
    background: linear-gradient(135deg, #e0f2fe, #dbeafe);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: #94a3b8;
}

.card-content {
    padding: 1.25rem;
}

.card-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #1e293b;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.card-badges {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.badge-modern {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(99, 102, 241, 0.1);
    color: var(--color-primary);
}

.badge-modern.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-danger);
}

.badge-modern.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
}

.card-time {
    font-size: 0.875rem;
    color: #64748b;
}

.card-action {
    padding: 0 1.25rem 1.25rem;
}

.btn-modern {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.95rem;
}

.btn-modern.btn-primary {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}

.btn-modern.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
}

.btn-modern.btn-secondary {
    background: rgba(226, 232, 240, 0.8);
    color: #475569;
}

.btn-modern.btn-secondary:hover {
    background: rgba(203, 213, 225, 0.8);
    transform: translateY(-2px);
}

/* å¿«é€Ÿæ“ä½œ */
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.action-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem 1rem;
    text-align: center;
    transition: var(--transition);
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    backdrop-filter: blur(10px);
}

.action-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
}

.action-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 1.25rem;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
}

.action-icon.success {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
}

.action-icon.info {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
    box-shadow: 0 4px 20px rgba(6, 182, 212, 0.3);
}

.action-icon.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
}

.action-icon i {
    color: white;
    font-size: 2rem;
}

.action-label {
    font-weight: 700;
    font-size: 1.1rem;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.action-desc {
    font-size: 0.875rem;
    color: #64748b;
}

/* æ¨¡æ€æ¡† - Glass */
.modal-glass .modal-content {
    border: none;
    border-radius: 24px;
    overflow: hidden;
}

.glass-modal {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}

.glass-header {
    background: rgba(255, 255, 255, 0.3);
    border-bottom: 1px solid var(--glass-border);
    padding: 1.5rem 2rem;
}

.glass-body {
    padding: 2rem;
}

.glass-footer {
    background: rgba(255, 255, 255, 0.3);
    border-top: 1px solid var(--glass-border);
    padding: 1.5rem 2rem;
}

/* æ¨¡æ€æ¡†å†…å®¹æ¨¡æ€æ¡†å†…å®¹ */
.detail-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
}

@media (max-width: 768px) {
    .detail-grid {
        grid-template-columns: 1fr;
    }
}

.exercise-content {
    background: rgba(255, 255, 255, 0.6);
    padding: 1.5rem;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.05);
}

.exercise-images {
    display: grid;
    gap: 1.5rem;
}

.image-card {
    background: rgba(255, 255, 255, 0.6);
    padding: 1rem;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.05);
}

.image-card h6 {
    margin-bottom: 1rem;
    color: #1e293b;
}

.image-card img {
    width: 100%;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.sidebar-card {
    background: rgba(255, 255, 255, 0.6);
    padding: 1.5rem;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.05);
}

.sidebar-card h6 {
    margin-bottom: 1rem;
    color: #1e293b;
    font-weight: 600;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.info-row:last-child {
    border-bottom: none;
}

.knowledge-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tag {
    padding: 0.25rem 0.75rem;
    background: rgba(99, 102, 241, 0.1);
    color: var(--color-primary);
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .hero-card {
        padding: 1.5rem;
    }
    
    .typewriter {
        animation: none;
        border: none;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .action-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åŠ è½½
    loadDashboardData();
    
    // é¡µé¢åŠ è½½åŠ¨ç”»
    initializeAnimations();
});

// åŠ¨ç”»åˆå§‹åŒ–
function initializeAnimations() {
    const cards = document.querySelectorAll('.fade-in');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
    });
}

// åŠ è½½ä»ªè¡¨æ¿æ•°æ®
async function loadDashboardData() {
    try {
        const data = await apiRequest('/exercises/dashboard/stats/');
        
        if (data) {
            // åŠ¨ç”»æ›´æ–°ç»Ÿè®¡æ•°æ®
            animateStatsCards(data);
            updateSubjectStats(data.subject_stats);
            updateWeakKnowledgePoints(data.weak_knowledge_points);
            updateRecentMistakes(data.recent_mistakes);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showErrorMessage();
    }
}

// åŠ¨ç”»æ›´æ–°ç»Ÿè®¡å¡ç‰‡
function animateStatsCards(data) {
    const stats = [
        { id: 'totalExercises', value: data.total_exercises || 0, max: 1000 },
        { id: 'mistakeCount', value: data.mistake_count || 0, max: 500 },
        { id: 'practiceCount', value: data.practice_count || 0, max: 1000 },
        { id: 'accuracyRate', value: data.accuracy_rate || 0, max: 100, isPercentage: true }
    ];
    
    stats.forEach(stat => {
        const element = document.getElementById(stat.id);
        const finalValue = stat.isPercentage ? `${stat.value}%` : formatNumber(stat.value);
        
        // æ•°å­—æ»šåŠ¨åŠ¨ç”»
        animateValue(element, 0, stat.value, 1500, stat.isPercentage);
        
        // è¿›åº¦æ¡åŠ¨ç”»
        const progressBar = element.closest('.stat-card').querySelector('.stat-progress');
        const progressPercent = Math.min((stat.value / stat.max) * 100, 100);
        setTimeout(() => {
            progressBar.style.width = `${progressPercent}%`;
        }, 300);
    });
}

// æ•°å­—æ»šåŠ¨åŠ¨ç”»
function animateValue(element, start, end, duration, isPercentage = false) {
    const range = end - start;
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + range * progress);
        
        element.textContent = isPercentage ? `${current}%` : formatNumber(current);
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

// æ›´æ–°å­¦ç§‘ç»Ÿè®¡
function updateSubjectStats(subjectStats) {
    const container = document.getElementById('subjectStats');
    
    if (!subjectStats || subjectStats.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                <p>æš‚æ— å­¦ç§‘ç»Ÿè®¡æ•°æ®</p>
                <a href="/upload/" class="btn-modern btn-primary mt-3">å¼€å§‹ç¬¬ä¸€é¢˜</a>
            </div>
        `;
        return;
    }
    
    const html = subjectStats.map(subject => {
        const accuracy = subject.accuracy_rate || 0;
        const badgeClass = accuracy >= 80 ? 'success' : accuracy >= 60 ? 'warning' : 'danger';
        const badgeColor = accuracy >= 80 ? '#10b981' : accuracy >= 60 ? '#f59e0b' : '#ef4444';
        
        return `
            <div class="subject-item">
                <div class="subject-header">
                    <div class="subject-name">${subject.subject_name}</div>
                    <div class="accuracy-badge" style="background: ${badgeColor}10; color: ${badgeColor};">
                        ${formatPercentage(accuracy)}
                    </div>
                </div>
                <div class="progress-custom">
                    <div class="progress-fill" style="background: ${badgeColor}; width: ${accuracy}%"></div>
                </div>
                <div class="subject-meta">
                    <span><i class="fas fa-database me-1"></i>æ€»é¢˜æ•°: ${subject.total_exercises}</span>
                    <span><i class="fas fa-times-circle me-1"></i>é”™é¢˜: ${subject.mistake_count}</span>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="row">${html}</div>`;
    
    // åŠ¨ç”»è¿›åº¦æ¡
    setTimeout(() => {
        document.querySelectorAll('.progress-fill').forEach(bar => {
            bar.style.width = bar.style.width;
        });
    }, 100);
}

// æ›´æ–°è–„å¼±çŸ¥è¯†ç‚¹
function updateWeakKnowledgePoints(weakPoints) {
    const container = document.getElementById('weakKnowledgePoints');
    
    if (!weakPoints || weakPoints.length === 0) {
        container.innerHTML = `
            <div class="empty-state text-center py-5">
                <i class="fas fa-trophy fa-3x mb-3 text-success"></i>
                <h5 class="chinese-text">å¤ªæ£’äº†ï¼</h5>
                <p class="chinese-text">ä½ ç›®å‰æ²¡æœ‰æ˜æ˜¾çš„è–„å¼±çŸ¥è¯†ç‚¹</p>
                <div class="confetti">ğŸ‰</div>
            </div>
        `;
        return;
    }
    
    const html = weakPoints.map(point => {
        const mastery = point.mastery_level || 0;
        const badgeClass = mastery < 40 ? 'error' : mastery < 60 ? 'warning' : 'info';
        const statusText = mastery < 40 ? 'éœ€åŠ å¼º' : mastery < 60 ? 'å¾…æå‡' : 'è‰¯å¥½';
        
        return `
            <div class="mistake-card" onclick="viewKnowledgePoint('${point.knowledge_point}', '${point.subject}')">
                <div class="card-image">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="card-content">
                    <h6 class="card-title chinese-text">${point.knowledge_point}</h6>
                    <div class="card-badges">
                        <span class="badge-modern">${point.subject}</span>
                        <span class="badge-modern ${badgeClass}">${statusText}</span>
                    </div>
                    <div class="card-time">
                        <i class="fas fa-chart-line me-1"></i>${formatPercentage(mastery)} æŒæ¡åº¦
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="mistakes-grid-auto">${html}</div>`;
}

// æ›´æ–°æœ€è¿‘é”™é¢˜
function updateRecentMistakes(mistakes) {
    const container = document.getElementById('recentMistakes');
    
    if (!mistakes || mistakes.length === 0) {
        container.innerHTML = `
            <div class="empty-state text-center py-5">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h5>æš‚æ— é”™é¢˜</h5>
                <p>å¼€å§‹ä¸Šä¼ ä½ çš„ç¬¬ä¸€é“é”™é¢˜å§ï¼</p>
                <a href="/upload/" class="btn-modern btn-primary mt-3">
                    <i class="fas fa-upload me-2"></i>ä¸Šä¼ é”™é¢˜
                </a>
            </div>
        `;
        return;
    }
    
    const html = mistakes.map(mistake => {
        const statusBadge = mistake.status === 'wrong' ? 'error' : 
                           mistake.status === 'correct' ? 'success' : 'warning';
        const statusText = mistake.status === 'wrong' ? 'å¾…æ”»å…‹' : 
                          mistake.status === 'correct' ? 'å·²æŒæ¡' : 'æœªå°è¯•';
        
        return `
            <div class="mistake-card" onclick="viewExercise(${mistake.id})">
                <div class="card-image">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="card-content">
                    <h6 class="card-title">${mistake.exercise_title}</h6>
                    <div class="card-badges">
                        <span class="badge-modern">${mistake.subject}</span>
                        <span class="badge-modern ${statusBadge}">${statusText}</span>
                    </div>
                    <div class="card-time">
                        <i class="fas fa-clock me-1"></i>${formatDate(mistake.upload_time)}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="mistakes-grid">${html}</div>`;
}

// æŸ¥çœ‹ä¹ é¢˜è¯¦æƒ…
async function viewExercise(mistakeId) {
    const modal = new bootstrap.Modal(document.getElementById('exerciseDetailModal'));
    modal.show();
    
    try {
        // é¦–å…ˆè·å–å­¦ç”Ÿä¹ é¢˜è®°å½•
        const studentExercise = await apiRequest(`/exercises/student-exercises/${mistakeId}/`);
        
        if (studentExercise && studentExercise.exercise) {
            // ç„¶åè·å–ä¹ é¢˜è¯¦æƒ…
            const exercise = await apiRequest(`/exercises/${studentExercise.exercise}/`);
            displayExerciseDetail(exercise, studentExercise);
        } else {
            throw new Error('å­¦ç”Ÿä¹ é¢˜è®°å½•æ•°æ®ä¸å®Œæ•´');
        }
    } catch (error) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
        document.getElementById('exerciseDetailContent').innerHTML = `
            <div class="text-center py-5 text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>åŠ è½½å¤±è´¥</h5>
                <p class="text-muted">${error.message || 'è¯·ç¨åé‡è¯•'}</p>
                <button class="btn-modern btn-primary mt-3" onclick="viewExercise(${mistakeId})">
                    <i class="fas fa-redo me-2"></i>é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    }
}

// æ˜¾ç¤ºä¹ é¢˜è¯¦æƒ…
function displayExerciseDetail(exercise, studentExercise) {
    // è·å–æ¨¡æ€æ¡†å®ä¾‹
    const modalElement = document.getElementById('exerciseDetailModal');
    const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
    
    const statusBadge = {
        'not_attempted': 'secondary',
        'correct': 'success',
        'wrong': 'danger'
    }[studentExercise.status] || 'secondary';
    
    const statusText = {
        'not_attempted': 'æœªå°è¯•',
        'correct': 'æ­£ç¡®',
        'wrong': 'é”™é¢˜'
    }[studentExercise.status] || 'æœªçŸ¥';
    
    const difficultyBadge = {
        'easy': 'success',
        'medium': 'warning',
        'hard': 'danger'
    }[exercise.difficulty] || 'secondary';
    
    const difficultyText = {
        'easy': 'ç®€å•',
        'medium': 'ä¸­ç­‰',
        'hard': 'å›°éš¾'
    }[exercise.difficulty] || 'æœªçŸ¥';
    
    const html = `
        <div class="detail-grid">
            <div class="exercise-content">
                <div class="mb-4">
                    <h4 class="mb-3">${exercise.title || 'æœªå‘½åé¢˜ç›®'}</h4>
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <span class="badge-modern">${exercise.subject_name || 'æœªçŸ¥å­¦ç§‘'}</span>
                        <span class="badge-modern ${difficultyBadge}">${difficultyText}</span>
                        <span class="badge-modern ${statusBadge}">${statusText}</span>
                    </div>
                </div>
                
                <div class="exercise-images">
                    ${exercise.question_text ? `
                        <div class="image-card">
                            <h6><i class="fas fa-question-circle me-2 text-primary"></i>é¢˜ç›®å†…å®¹</h6>
                            <div class="bg-light p-3 rounded">
                                ${exercise.question_text}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${exercise.question_image ? `
                        <div class="image-card">
                            <h6><i class="fas fa-image me-2 text-primary"></i>é¢˜ç›®å›¾ç‰‡</h6>
                            <img src="${exercise.question_image}" alt="é¢˜ç›®å›¾ç‰‡" class="img-fluid">
                        </div>
                    ` : ''}
                    
                    ${studentExercise.student_answer_image ? `
                        <div class="image-card">
                            <h6><i class="fas fa-pen me-2 text-info"></i>ä½ çš„ç­”æ¡ˆ</h6>
                            <img src="${studentExercise.student_answer_image}" alt="å­¦ç”Ÿç­”æ¡ˆ" class="img-fluid">
                            ${studentExercise.student_answer_text ? `
                                <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                    <small>${studentExercise.student_answer_text}</small>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div class="sidebar-card">
                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>ä¹ é¢˜ä¿¡æ¯</h6>
                <div class="info-row">
                    <span>å¹´çº§</span>
                    <span class="fw-600">${exercise.grade_level || 'æœªçŸ¥'}</span>
                </div>
                <div class="info-row">
                    <span>ä¸Šä¼ æ—¶é—´</span>
                    <span>${formatDate(studentExercise.upload_time)}</span>
                </div>
                <div class="info-row">
                    <span>å½“å‰çŠ¶æ€</span>
                    <span class="badge-modern ${statusBadge}">${statusText}</span>
                </div>
                
                ${exercise.knowledge_points && exercise.knowledge_points.length ? `
                    <div class="mt-3">
                        <h6 class="mb-2"><i class="fas fa-tags me-2"></i>çŸ¥è¯†ç‚¹</h6>
                        <div class="knowledge-tags">
                            ${exercise.knowledge_points.map(kp => `<span class="tag">${kp.name || kp}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('exerciseDetailContent').innerHTML = html;
    
    // è®¾ç½®ç»ƒä¹ æŒ‰é’®
    const practiceBtn = document.getElementById('practiceThisBtn');
    if (practiceBtn) {
        practiceBtn.onclick = () => {
            try {
                modal.hide();
                // ç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨å…³é—­åå†è·³è½¬
                setTimeout(() => {
                    window.location.href = `/answer/${studentExercise.id}/`;
                }, 300);
            } catch (error) {
                console.error('è·³è½¬ç»ƒä¹ é¡µé¢å¤±è´¥:', error);
                // å¦‚æœæ¨¡æ€æ¡†å…³é—­å¤±è´¥ï¼Œç›´æ¥è·³è½¬
                window.location.href = `/answer/${studentExercise.id}/`;
            }
        };
    }
}

// æŸ¥çœ‹çŸ¥è¯†ç‚¹è¯¦æƒ…
function viewKnowledgePoint(knowledgePoint, subject) {
    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
    const card = event.currentTarget;
    card.style.transform = 'scale(0.95)';
    setTimeout(() => {
        card.style.transform = '';
        showMessage(`æ­£åœ¨æŸ¥çœ‹çŸ¥è¯†ç‚¹: ${knowledgePoint} (${subject})`, 'info');
        // å®é™…é¡¹ç›®ä¸­è¿™é‡Œå¯ä»¥è·³è½¬åˆ°çŸ¥è¯†ç‚¹è¯¦æƒ…é¡µæˆ–å¼€å§‹ç›¸å…³ç»ƒä¹ 
        // window.location.href = `/practice/?knowledge=${encodeURIComponent(knowledgePoint)}&subject=${encodeURIComponent(subject)}`;
    }, 150);
}

// æŸ¥çœ‹æ‰€æœ‰é”™é¢˜
function viewAllMistakes() {
    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
    const btn = event.currentTarget;
    btn.style.transform = 'scale(0.95)';
    setTimeout(() => {
        btn.style.transform = '';
        window.location.href = '/mistakes/';
    }, 150);
}

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(num) {
    return num.toLocaleString('zh-CN');
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”
function formatPercentage(value) {
    return `${Math.round(value)}%`;
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'ä»Šå¤©';
    if (diffDays === 1) return 'æ˜¨å¤©';
    if (diffDays < 7) return `${diffDays}å¤©å‰`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`;
    
    return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' });
}

// é”™è¯¯æç¤º
function showErrorMessage() {
    const elements = ['subjectStats', 'weakKnowledgePoints', 'recentMistakes'];
    elements.forEach(id => {
        const container = document.getElementById(id);
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                <h5>æ•°æ®åŠ è½½å¤±è´¥</h5>
                <p class="text-muted mb-4">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
                <button class="btn-modern btn-primary" onclick="loadDashboardData()">
                    <i class="fas fa-redo me-2"></i>é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    });
}

// æ¶ˆæ¯æç¤º
function showMessage(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-modern toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
}
</script>
{% endblock %}
